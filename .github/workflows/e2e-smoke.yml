name: E2E Smoke

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  smoke:
    name: Protocol E2E Smoke
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install grpcurl
        run: |
          go install github.com/fullstorydev/grpcurl/cmd/grpcurl@v1.9.1
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build
        run: cargo build --release

      - name: OpenAPI smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          openapi_list="$($UXC https://petstore3.swagger.io/api/v3 list)"
          grep -q "GET /store/inventory" <<<"$openapi_list"
          $UXC https://petstore3.swagger.io/api/v3 call "GET /store/inventory" \
            | jq -e '.ok == true and .protocol == "openapi"'

      - name: GraphQL smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          graphql_list=""
          for attempt in 1 2 3; do
            if graphql_list="$("$UXC" https://countries.trevorblades.com/ list)" \
              && grep -q "query/country" <<<"$graphql_list"; then
              break
            fi
            if [[ "$attempt" -eq 3 ]]; then
              echo "GraphQL list failed after retries:"
              echo "$graphql_list"
              exit 1
            fi
            sleep 2
          done

          for attempt in 1 2 3; do
            if "$UXC" https://countries.trevorblades.com/ call query/country --json '{"code":"US"}' \
              | jq -e '.ok == true and .protocol == "graphql"'; then
              break
            fi
            if [[ "$attempt" -eq 3 ]]; then
              echo "GraphQL call failed after retries"
              exit 1
            fi
            sleep 2
          done

      - name: gRPC smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          grpc_list="$($UXC grpcb.in:9000 list)"
          grep -q "addsvc.Add/Sum" <<<"$grpc_list"
          $UXC grpcb.in:9000 call addsvc.Add/Sum --json '{"a":1,"b":2}' \
            | jq -e '.ok == true and .protocol == "grpc" and .result.v == "3"'

      - name: MCP HTTP smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          mcp_http_list="$($UXC https://mcp.deepwiki.com/mcp list)"
          grep -q "read_wiki_structure" <<<"$mcp_http_list"
          $UXC https://mcp.deepwiki.com/mcp call read_wiki_structure --json '{"repoName":"jolestar/uxc"}' \
            | jq -e '.ok == true and .protocol == "mcp"'

      - name: MCP stdio smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          MCP_STDIO='npx -y @modelcontextprotocol/server-filesystem /tmp'
          mcp_stdio_list="$("$UXC" "$MCP_STDIO" list)"
          grep -q "list_directory" <<<"$mcp_stdio_list"
          "$UXC" "$MCP_STDIO" call list_directory --json '{"path":"/tmp"}' \
            | jq -e '.ok == true and .protocol == "mcp"'
