name: E2E Smoke

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  smoke:
    name: Protocol E2E Smoke
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install grpcurl
        run: |
          go install github.com/fullstorydev/grpcurl/cmd/grpcurl@v1.9.1
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build
        run: cargo build --release

      - name: OpenAPI smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          $UXC https://petstore3.swagger.io/api/v3 list \
            | jq -e '.ok == true and .kind == "operation_list" and any(.data.operations[]; .name == "GET /store/inventory")'
          $UXC https://petstore3.swagger.io/api/v3 "GET /store/inventory" \
            | jq -e '.ok == true and .protocol == "openapi" and .kind == "call_result"'

      - name: GraphQL smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          for attempt in 1 2 3; do
            if "$UXC" https://countries.trevorblades.com/ list \
              | jq -e '.ok == true and any(.data.operations[]; .name == "query/country")' >/dev/null; then
              break
            fi
            if [[ "$attempt" -eq 3 ]]; then
              echo "GraphQL list failed after retries"
              exit 1
            fi
            sleep 2
          done

          for attempt in 1 2 3; do
            if "$UXC" https://countries.trevorblades.com/ query/country --json '{"code":"US"}' \
              | jq -e '.ok == true and .protocol == "graphql" and .kind == "call_result"'; then
              break
            fi
            if [[ "$attempt" -eq 3 ]]; then
              echo "GraphQL call failed after retries"
              exit 1
            fi
            sleep 2
          done

      - name: gRPC smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          $UXC grpcb.in:9000 list \
            | jq -e '.ok == true and any(.data.operations[]; .name == "addsvc.Add/Sum")'
          $UXC grpcb.in:9000 addsvc.Add/Sum --json '{"a":1,"b":2}' \
            | jq -e '.ok == true and .protocol == "grpc" and .data.v == "3"'

      - name: MCP HTTP smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          $UXC https://mcp.deepwiki.com/mcp list \
            | jq -e '.ok == true and any(.data.operations[]; .name == "read_wiki_structure")'
          $UXC https://mcp.deepwiki.com/mcp read_wiki_structure --json '{"repoName":"jolestar/uxc"}' \
            | jq -e '.ok == true and .protocol == "mcp"'

      - name: MCP stdio smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc
          MCP_STDIO='npx -y @modelcontextprotocol/server-filesystem /tmp'
          "$UXC" "$MCP_STDIO" list \
            | jq -e '.ok == true and any(.data.operations[]; .name == "list_directory")'
          "$UXC" "$MCP_STDIO" list_directory --json '{"path":"/tmp"}' \
            | jq -e '.ok == true and .protocol == "mcp"'
