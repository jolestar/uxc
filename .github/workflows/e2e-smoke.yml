name: E2E Smoke Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run smoke tests daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual triggering

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  smoke:
    name: Protocol E2E Smoke
    runs-on: ubuntu-latest
    # Make smoke tests non-blocking for PRs (they still run but don't block merge)
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install grpcurl
        run: |
          go install github.com/fullstorydev/grpcurl/cmd/grpcurl@v1.9.1
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build
        run: cargo build --release

      - name: OpenAPI smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc

          echo "=== Testing OpenAPI endpoint: https://petstore3.swagger.io/api/v3 ==="

          # List operations with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Listing operations..."
            if OUTPUT=$($UXC https://petstore3.swagger.io/api/v3 list 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and .kind == "operation_list" and any(.data.operations[]; .operation_id == "get:/store/inventory")' >/dev/null; then
                echo "✓ List operations succeeded"
                break
              else
                echo "✗ List operations returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ List operations failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== OpenAPI list test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          # Call operation with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Calling get:/store/inventory..."
            if OUTPUT=$($UXC https://petstore3.swagger.io/api/v3 get:/store/inventory 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and .protocol == "openapi" and .kind == "call_result"' >/dev/null; then
                echo "✓ Call operation succeeded"
                echo "Sample response:"
                echo "$OUTPUT" | jq '.data | keys | .[0:3]'  # Show first 3 keys
                break
              else
                echo "✗ Call operation returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ Call operation failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== OpenAPI call test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          echo "=== OpenAPI smoke tests passed ==="

      - name: GraphQL smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc

          echo "=== Testing GraphQL endpoint: https://countries.trevorblades.com/ ==="

          # List operations with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Listing operations..."
            if OUTPUT=$($UXC https://countries.trevorblades.com/ list 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and any(.data.operations[]; .operation_id == "query/country")' >/dev/null; then
                echo "✓ List operations succeeded"
                break
              else
                echo "✗ List operations returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ List operations failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== GraphQL list test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          # Call operation with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Calling query/country..."
            if OUTPUT=$($UXC https://countries.trevorblades.com/ query/country --json '{"code":"US"}' 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and .protocol == "graphql" and .kind == "call_result"' >/dev/null; then
                echo "✓ Call operation succeeded"
                echo "Country data:"
                echo "$OUTPUT" | jq '.data.data.country | {name, code, capital}'
                break
              else
                echo "✗ Call operation returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ Call operation failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== GraphQL call test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          echo "=== GraphQL smoke tests passed ==="

      - name: gRPC smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc

          echo "=== Testing gRPC endpoint: grpcb.in:9000 ==="

          # List operations with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Listing operations..."
            if OUTPUT=$($UXC grpcb.in:9000 list 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and any(.data.operations[]; .operation_id == "addsvc.Add/Sum")' >/dev/null; then
                echo "✓ List operations succeeded"
                break
              else
                echo "✗ List operations returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ List operations failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== gRPC list test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          # Call operation with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Calling addsvc.Add/Sum..."
            if OUTPUT=$($UXC grpcb.in:9000 addsvc.Add/Sum --json '{"a":1,"b":2}' 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and .protocol == "grpc" and .data.v == "3"' >/dev/null; then
                echo "✓ Call operation succeeded"
                echo "Result: 1 + 2 = $($UXC grpcb.in:9000 addsvc.Add/Sum --json '{"a":1,"b":2}' | jq -r '.data.v')"
                break
              else
                echo "✗ Call operation returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ Call operation failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== gRPC call test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          echo "=== gRPC smoke tests passed ==="

      - name: MCP HTTP smoke
        shell: bash
        run: |
          set -euo pipefail
          UXC=target/release/uxc

          echo "=== Testing MCP HTTP endpoint: https://mcp.deepwiki.com/mcp ==="

          # List operations with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Listing operations..."
            if OUTPUT=$($UXC https://mcp.deepwiki.com/mcp list 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and any(.data.operations[]; .operation_id == "read_wiki_structure")' >/dev/null; then
                echo "✓ List operations succeeded"
                break
              else
                echo "✗ List operations returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ List operations failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== MCP HTTP list test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          # Call operation with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Calling read_wiki_structure..."
            if OUTPUT=$($UXC https://mcp.deepwiki.com/mcp read_wiki_structure --json '{"repoName":"holon-run/uxc"}' 2>&1); then
              if echo "$OUTPUT" | jq -e '.ok == true and .protocol == "mcp"' >/dev/null; then
                echo "✓ Call operation succeeded"
                break
              else
                echo "✗ Call operation returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ Call operation failed with exit code $?:"
              echo "$OUTPUT"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== MCP HTTP call test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          echo "=== MCP HTTP smoke tests passed ==="

      - name: MCP stdio smoke
        shell: bash
        run: |
          set -euo pipefail
          export npm_config_loglevel=error
          UXC=target/release/uxc
          MCP_STDIO='npx -y @modelcontextprotocol/server-filesystem /tmp'

          echo "=== Testing MCP stdio with @modelcontextprotocol/server-filesystem ==="

          # List operations with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Listing operations..."
            if OUTPUT=$("$UXC" "$MCP_STDIO" list); then
              if echo "$OUTPUT" | jq -e '.ok == true and any(.data.operations[]; .operation_id == "list_directory")' >/dev/null; then
                echo "✓ List operations succeeded"
                break
              else
                echo "✗ List operations returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ List operations failed with exit code $?:"
              echo "${OUTPUT:-<empty stdout>}"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== MCP stdio list test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          # Call operation with retry
          for attempt in {1..3}; do
            echo "Attempt $attempt/3: Calling list_directory..."
            if OUTPUT=$("$UXC" "$MCP_STDIO" list_directory --json '{"path":"/tmp"}'); then
              if echo "$OUTPUT" | jq -e '.ok == true and .protocol == "mcp"' >/dev/null; then
                echo "✓ Call operation succeeded"
                echo "Found $(echo "$OUTPUT" | jq '.data.data | length') entries in /tmp"
                break
              else
                echo "✗ Call operation returned unexpected output:"
                echo "$OUTPUT" | jq '.'
              fi
            else
              echo "✗ Call operation failed with exit code $?:"
              echo "${OUTPUT:-<empty stdout>}"
            fi

            if [[ "$attempt" -eq 3 ]]; then
              echo "=== MCP stdio call test failed after 3 attempts ==="
              echo "Last output:"
              echo "$OUTPUT" | jq '.' || echo "$OUTPUT"
              exit 1
            fi
            echo "Retrying in 3 seconds..."
            sleep 3
          done

          echo "=== MCP stdio smoke tests passed ==="

      - name: Smoke tests summary
        if: always()
        run: |
          echo "=== Smoke Tests Summary ==="
          echo "All external service smoke tests have completed."
          echo "These tests verify compatibility with real public APIs:"
          echo "  - OpenAPI: https://petstore3.swagger.io/api/v3"
          echo "  - GraphQL: https://countries.trevorblades.com/"
          echo "  - gRPC: grpcb.in:9000"
          echo "  - MCP HTTP: https://mcp.deepwiki.com/mcp"
          echo "  - MCP stdio: @modelcontextprotocol/server-filesystem"
          echo ""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ℹ️  Running on PR - failures are non-blocking (for compatibility monitoring only)"
          else
            echo "✅ Running on main branch - failures will block merge"
          fi
