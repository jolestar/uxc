name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  verify:
    name: Verify Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Validate version and run checks
        run: |
          bash scripts/release-check.sh "${GITHUB_REF_NAME}"

  build:
    name: Build ${{ matrix.target }}
    needs: verify
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: "false"
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: "true"
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use_cross: "true"
          - os: macos-13
            target: x86_64-apple-darwin
            use_cross: "false"
          - os: macos-14
            target: aarch64-apple-darwin
            use_cross: "false"
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross == 'true'
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            cross build --release --target "${{ matrix.target }}"
          else
            cargo build --release --target "${{ matrix.target }}"
          fi

      - name: Package (Unix)
        if: runner.os != 'Windows'
        id: package_unix
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          PKG_ROOT="uxc-v${VERSION}-${{ matrix.target }}"
          mkdir -p "${PKG_ROOT}"
          cp "target/${{ matrix.target }}/release/uxc" "${PKG_ROOT}/uxc"
          cp LICENSE "${PKG_ROOT}/LICENSE"
          cp README.md "${PKG_ROOT}/README.md"
          tar -czf "${PKG_ROOT}.tar.gz" "${PKG_ROOT}"
          echo "file=${PKG_ROOT}.tar.gz" >> "${GITHUB_OUTPUT}"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        id: package_windows
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.Substring(1)
          $pkgRoot = "uxc-v$version-${{ matrix.target }}"
          New-Item -ItemType Directory -Path $pkgRoot | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/uxc.exe" "$pkgRoot/uxc.exe"
          Copy-Item "LICENSE" "$pkgRoot/LICENSE"
          Copy-Item "README.md" "$pkgRoot/README.md"
          Compress-Archive -Path "$pkgRoot/*" -DestinationPath "$pkgRoot.zip"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "file=$pkgRoot.zip"

      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.target }}
          path: ${{ steps.package_unix.outputs.file }}

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.target }}
          path: ${{ steps.package_windows.outputs.file }}

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          path: dist
          merge-multiple: true

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          cd dist
          sha256sum * > "uxc-v${VERSION}-checksums.txt"

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*

  publish-crate:
    name: Publish Crate
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [[ -z "${CARGO_REGISTRY_TOKEN}" ]]; then
            echo "CARGO_REGISTRY_TOKEN is not configured"
            exit 1
          fi
          cargo publish --locked --token "${CARGO_REGISTRY_TOKEN}"

  update-homebrew-tap:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    if: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pkg-*
          path: dist
          merge-multiple: true

      - name: Update tap formula
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          bash scripts/update-homebrew-formula.sh \
            --version "${GITHUB_REF_NAME#v}" \
            --dist-dir dist \
            --repo "${GITHUB_REPOSITORY}" \
            --tap-repo "jolestar/homebrew-uxc"
